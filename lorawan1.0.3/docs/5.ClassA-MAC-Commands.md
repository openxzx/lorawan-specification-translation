# MAC Commands

    For network administration, a set of MAC commands can be exchanged exclusively between
    the network server and the MAC layer on an end-device. MAC layer commands are never
    visible to the application or the application server or the application running on the end-device.
    对于网络管理，一组MAC命令可以在网络服务器和终端设备上的MAC层之间独占地交换。
    MAC层命令对应用程序、应用服务器或运行在终端设备上的应用程序永远不可见。

    A single data frame can contain any sequence of MAC commands, either piggybacked in the
    FOpts field or, when sent as a separate data frame, in the FRMPayload field with the FPort
    field being set to 0. Piggybacked MAC commands are always sent without encryption and
    MUST NOT exceed 15 octets. MAC commands sent as FRMPayload are always encrypted
    and MUST NOT exceed the maximum FRMPayload length.
    一个单独的数据帧可以包含任何MAC命令序列，可以是FOpts字段中的命令，
    也可以是作为单独的数据帧发送到FRMPayload字段中，FPort字段设置为0。
    附带的MAC命令总是在没有加密的情况下发送，并且不能超过15个八位字节。
    作为FRMPayload发送的MAC命令始终是加密的，并且不能超过FRMPayload的最大长度。

    Note: MAC commands whose content shall not be disclosed to an
    eavesdropper must be sent in the FRMPayload of a separate data message.
    注：MAC命令的内容不得透露给窃听者，必须在单独数据消息的FRMPayload中发送。

    A MAC command consists of a command identifier (CID) of 1 octet followed by a possibly
    empty command-specific sequence of octets.
    MAC命令由1个八位字节的命令标识符（CID）组成，后跟一个可能为空的特定于命令的八位字节序列。

![avatar](./mac-cmd1.png)
![avatar](./mac-cmd2.png)

    Note: The length of a MAC command is not explicitly given and must be
    implicitly known by the MAC implementation. Therefore unknown MAC
    commands cannot be skipped and the first unknown MAC command
    terminates the processing of the MAC command sequence. It is
    therefore advisable to order MAC commands according to the version
    of the LoRaWAN specification which has introduced a MAC command
    for the first time. This way all MAC commands up to the version of the
    LoRaWAN specification implemented can be processed even in the
    presence of MAC commands specified only in a version of the
    LoRaWAN specification newer than that implemented.
    注意：MAC命令的长度没有明确给出，必须由MAC实现隐式知道。
    因此未知MAC无法跳过命令和第一个未知的MAC命令终止对MAC命令序列的处理。
    因此，建议根据首次引入MAC命令的LoRaWAN规范版本来订购MAC命令。
    通过这种方式，即使存在仅在比所实施的LoRaWAN规范版本新的MAC命令指定的MAC命令存在的情况下，
    也可以处理到所实现的LoRaWAN规范版本之前的所有MAC命令。

    Note: Any values adjusted by the network server (e.g., RX2, new or adjusted channels definitions)
    remain only valid until the next join of the end-device.
    Therefore after each successful join procedure the end638 device uses the default parameters again
    and it is up to the network server to re-adjust the values again as needed.
    注：由网络服务器调整的任何值（例如，RX2、新的或调整的信道定义）仅在终端设备的下一个连接之前有效。
    因此，在每次成功的连接过程之后，终端设备都会再次使用默认参数，并由网络服务器根据需要重新调整这些值。

## 5.1 Link Check commands(链接检查命令) (LinkCheckReq, LinkCheckAns)

    With the LinkCheckReq command, an end-device MAY validate its connectivity with the
    network. The command has no payload.
    使用LinkCheckReq命令，终端设备可以验证其与网络的连接。该命令没有有效负载。

    When a LinkCheckReq is received by the network server via one or multiple gateways, it
    responds with a LinkCheckAns command.
    当网络服务器通过一个或多个网关接收到LinkCheckReq时，它用LinkCheckAns命令进行响应。

    |      Size(bytes)     |    1    |    1    |
    |------------------------------------------|
    | LinkCheckAns Payload |  Margin |  GwCnt  |

    The demodulation margin (Margin) is an 8-bit unsigned integer in the range of 0..254
    indicating the link margin in dB of the last successfully received LinkCheckReq command. A
    value of “0” means that the frame was received at the demodulation floor (0 dB or no margin)
    while a value of “20”, for example, means that the frame reached the gateway 20 dB above
    the demodulation floor. Value “255” is reserved.
    解调裕度（margin）是0..254范围内的8位无符号整数，表示最后成功接收到的LinkCheckReq命令的链路裕度（dB）。
    值“0”表示在解调层接收到帧（0db或无余量），而值“20”例如表示帧到达解调层上方的网关20db。保留值“255”。

    The gateway count (GwCnt) is the number of gateways that successfully received the last
    LinkCheckReq command.
    gateway count（GwCnt）是成功接收上一个LinkCheckReq命令的网关数。

## 5.2 Link ADR commands (LinkADRReq, LinkADRAns)

    With the LinkADRReq command, the network server requests an end-device to perform a rate adaptation.
    使用LinkADRReq命令，网络服务器请求终端设备执行速率自适应。

    |     Size(bytes)    |        1         |    2    |     1      |
    |--------------------------------------------------------------|
    | LinkADRReq Payload | DataRate_TXPower | ChMask  | Redundancy |

    |        Bits      |  [7:4]   |  [3:0]  |
    |---------------------------------------|
    | DataRate_TXPower | DataRate | TXPower |

    The requested data rate (DataRate) and TX output power (TXPower) are region-specific and
    are encoded as indicated in the “LoRaWAN regional physical layer specification” document.
    The TX output power indicated in the command is to be considered the maximum transmit
    power the device may operate at. An end-device will acknowledge as successful a command
    which specifies a higher transmit power than it is capable of using and should, in that case,
    operate at its maximum possible power. The channel mask (ChMask) encodes the channels
    usable for uplink access as follows with bit 0 corresponding to the LSB:
    请求的数据速率（DataRate）和TX输出功率（TXPower）是特定于区域的，
    并按照“LoRaWAN区域物理层规范”文档中的指示进行编码。
    命令中指示的TX输出功率被视为设备可能运行的最大发射功率。
    终端设备将确认命令成功，该命令指定了比其能够使用的更高的发射功率，
    在这种情况下，应以其最大可能的功率运行。
    信道掩码（ChMask）对可用于上行链路访问的信道进行如下编码，比特0对应于LSB：

    | Bits# | Usable channels |
    |-------------------------|
    |   0   |   Channel 1     |
    |   1   |   Channel 2     |
    |  ...  |   Channel ..    |
    |   15  |   Channel 16    |

    A bit in the ChMask field set to 1 means that the corresponding channel can be used for uplink
    transmissions if this channel allows the data rate currently used by the end-device. A bit set
    to 0 means the corresponding channels should be avoided.
    ChMask字段中的位设置为1意味着如果该信道允许终端设备当前使用的数据速率，
    则相应的信道可用于上行链路传输。位设为0表示应避免相应的通道。

    |       Bits      |  7  |   [6:4]    |  [3:0]  |
    |----------------------------------------------|
    | Redundancy bits | RFU | ChMaskCntl | NbTrans |

    In the Redundancy bits the NbTrans field is the number of transmissions for each uplink
    message. This applies only to “unconfirmed” uplink frames. The default value is 1
    corresponding to a single transmission of each frame. The valid range is [1:15]. If NbTrans==0
    is received the end-device should use the default value. This field can be used by the network
    manager to control the redundancy of the node uplinks to obtain a given Quality of Service.
    The end-device performs frequency hopping as usual between repeated transmissions, it
    does wait after each repetition until the receive windows have expired. . Whenever a downlink
    message is received during the RX1 slot window, it SHALL stop any further retransmission of
    the same uplink message. For class A devices, a reception in the RX2 slot has the same effect.
    在冗余位中，NbTrans字段是每个上行链路消息的传输次数。这只适用于“未确认”上行链路帧。
    默认值为1，对应于每个帧的单个传输。有效范围为[1:15]。如果接收到NbTrans==0，终端设备应使用默认值。
    该字段可由网络管理器用于控制节点上行链路的冗余，以获得给定的服务质量。
    终端设备像往常一样在重复传输之间执行跳频，每次重复之后它都会等待，直到接收窗口过期。
    每当在RX1时隙窗口期间接收到下行链路消息时，它应停止同一上行链路消息的任何进一步重传。
    对于A类设备，RX2插槽中的接收具有相同的效果。

    The channel mask control (ChMaskCntl) field controls the interpretation of the previously
    defined ChMask bit mask. It controls the block of 16 channels to which the ChMask applies.
    It can also be used to globally turn on or off all channels using specific modulation. This field
    usage is region specific and is defined in the “LoRaWAN regional physical layer specification”
    document.
    通道掩码控制（ChMaskCntl）字段控制先前定义的ChMask位掩码的解释。ChMask16的通道应用于哪个块。
    它还可以用于全局打开或关闭使用特定调制的所有信道。
    此字段的使用是特定于地区的，在“LoRaWAN区域物理层规范”文档中有定义。

    The network server MAY include multiple LinkAdrReq commands within a single downlink
    message. For the purpose of configuring the end-device channel mask, the end-device will
    process all contiguous LinkAdrReq messages, in the order present in the downlink message,
    as a single atomic block command. The end-device will accept or reject all Channel Mask
    controls in the contiguous block, and provide consistent Channel Mask ACK status indications
    for each command in the contiguous block in each LinkAdrAns message, reflecting the
    acceptance or rejection of this atomic channel mask setting. The device will only process the
    DataRate, TXPower and NbTrans from the last message in the contiguous block, as these
    settings govern the end-device global state for these values. The end-device will provide
    consistent ACK status in each LinkAdrAns message reflecting the acceptance or rejection of
    these final settings.
    网络服务器可以在单个下行链路消息中包括多个LinkAdrReq命令。
    为了配置终端设备信道掩码，终端设备将按照下行链路消息中的顺序，
    作为单个原子块命令来处理所有连续的LinkAdrReq消息。
    终端设备将接受或拒绝相邻块中的所有信道掩码控制，
    并在每个LinkAdrAns消息中为相邻块中的每个命令提供一致的信道掩码ACK状态指示，
    反映对该原子信道掩码设置的接受或拒绝。
    设备将只处理连续块中最后一条消息的DataRate、TXPower和NbTrans，因为这些设置控制这些值的终端设备全局状态。
    终端设备将在每个LinkAdrAns消息中提供一致的ACK状态，反映这些最终设置的接受或拒绝。

    The channel frequencies are region-specific and they are defined in Chapter 6. An end-device
    answers to a LinkADRReq with a LinkADRAns command.
    信道频率是特定于区域的，它们在第6章中定义。终端设备用LinkADRAns命令应答LinkADRReq。

    |     Size(bytes)    |    1    |
    |------------------------------|
    | LinkADRAns Payload | Status  |

    |     Bits    | [7:3] |     2     |       1       |        0         |
    |--------------------------------------------------------------------|
    | Status Bits |  RFU  | Power ACK | Data rate ACK | Channel mask ACK |

    The LinkADRAns Status bits have the following meaning:
    LinkADRAns状态位具有以下含义：

![avatar](./mac-cmd3.png)

    If any of those three bits equals 0, the command did not succeed and the node has kept the
    previous state.
    如果这三个位中的任何一位ACK等于0，则该命令没有成功，节点仍保持先前的状态。
