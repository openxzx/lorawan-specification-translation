# ClassB MAC commands

    All commands described in the Class A specification SHALL be implemented in Class B
    devices. The Class B specification adds the following MAC commands.
    Aç±»è§„èŒƒä¸­æè¿°çš„æ‰€æœ‰å‘½ä»¤åº”åœ¨Bç±»è®¾å¤‡ä¸­å®ç°ã€‚ClassBè§„èŒƒæ·»åŠ äº†ä»¥ä¸‹MACå‘½ä»¤ã€‚

![avatar](./chapter14-classB-mac-cmd.png)

## 14.1 PingSlotInfoReq

    With the PingSlotInfoReq command an end-device informs the server of its unicast ping slot
    periodicity. This command may only be used to inform the server of the periodicity of a
    UNICAST ping slot. A multicast slot is entirely defined by the application and
    should not use this command.
    ä½¿ç”¨PingSlotInfoReqå‘½ä»¤ï¼Œç»ˆç«¯è®¾å¤‡é€šçŸ¥æœåŠ¡å™¨å…¶å•æ’­pingæ—¶éš™å‘¨æœŸã€‚
    æ­¤å‘½ä»¤åªèƒ½ç”¨äºé€šçŸ¥æœåŠ¡å™¨å•æ’­pingæ—¶éš™çš„å‘¨æœŸæ€§ã€‚å¤šæ’­æ—¶éš™å®Œå…¨ç”±åº”ç”¨ç¨‹åºå®šä¹‰ï¼Œä¸åº”ä½¿ç”¨æ­¤å‘½ä»¤ã€‚

![avatar](./chapter14-PingSlotInfoReq.png)

    The Periodicity subfield is an unsigned 3 bits integer encoding the ping slot period currently
    used by the end-device using the following equation.
    å‘¨æœŸå­å­—æ®µæ˜¯ä¸€ä¸ªæ— ç¬¦å·3ä½æ•´æ•°ï¼Œä½¿ç”¨ä»¥ä¸‹ç­‰å¼ç¼–ç ç»ˆç«¯è®¾å¤‡å½“å‰ä½¿ç”¨çš„pingæ—¶éš™å‘¨æœŸã€‚

    ğ‘ğ‘–ğ‘›ğ‘”ğ‘ğ‘ = 2**(7âˆ’ğ‘ƒğ‘’ğ‘Ÿğ‘–ğ‘œğ‘‘ğ‘–ğ‘ğ‘–ğ‘¡ğ‘¦) ğ‘ğ‘›ğ‘‘ ğ‘ğ‘–ğ‘›ğ‘”ğ‘ƒğ‘’ğ‘Ÿğ‘–ğ‘œğ‘‘ = 2**(5+ğ‘ƒğ‘’ğ‘Ÿğ‘–ğ‘œğ‘‘ğ‘–ğ‘ğ‘–ğ‘¡y)

    The actual ping slot periodicity will be equal to 0.96 Ã— 2**ğ‘ƒğ‘’ğ‘Ÿğ‘–ğ‘œğ‘‘ğ‘–ğ‘ğ‘–ğ‘¡ğ‘¦ in seconds
    å®é™…pingæ—¶éš™å‘¨æœŸå°†ç­‰äº0.96Ã—2**Periodicityç§’

    Periodicity = 0 means that the end-device opens a ping slot approximately every
    second during the beacon_window interval.
    å‘¨æœŸæ€§=0è¡¨ç¤ºåœ¨ä¿¡æ ‡çª—å£é—´éš”æœŸé—´ï¼Œç»ˆç«¯è®¾å¤‡å¤§çº¦æ¯ç§’æ‰“å¼€ä¸€ä¸ªpingæ’æ§½ã€‚

    Periodicity = 7, every 128 seconds which is the maximum ping period supported by
    the LoRaWAN Class B specification.
    å‘¨æœŸ=7ï¼Œæ¯128ç§’ä¸€æ¬¡ï¼Œè¿™æ˜¯LoRaWAN Bç±»è§„èŒƒæ”¯æŒçš„æœ€å¤§pingå‘¨æœŸã€‚

    To change its ping slot periodicity a device SHALL first revert to Class A , send the new
    periodicity through a PingSlotInfoReq command and get an acknowledge from the server
    through a PingSlotInfoAns . It MAY then switch back to Class B with the new periodicity.
    è¦æ›´æ”¹å…¶pingæ’æ§½å‘¨æœŸï¼Œè®¾å¤‡åº”é¦–å…ˆæ¢å¤ä¸ºAç±»ï¼Œé€šè¿‡PingSlotInfoReqå‘½ä»¤å‘é€æ–°çš„å‘¨æœŸï¼Œ
    å¹¶é€šè¿‡PingSlotInfoAnsä»æœåŠ¡å™¨è·å¾—ç¡®è®¤ã€‚ç„¶åï¼Œå®ƒå¯èƒ½ä»¥æ–°çš„å‘¨æœŸæ€§åˆ‡æ¢å›Bç±»ã€‚

    This command MAY be concatenated with any other MAC command in the FHDRFOpt field
    as described in the Class A specification frame format.
    è¯¥å‘½ä»¤å¯ä»¥ä¸FHDRFOptå­—æ®µä¸­çš„ä»»ä½•å…¶ä»–MACå‘½ä»¤ä¸²è”ï¼Œå¦‚Aç±»è§„èŒƒå¸§æ ¼å¼ä¸­æ‰€æè¿°çš„ã€‚

## 14.2 BeaconFreqReq

    This command is sent by the server to the end-device to modify the frequency on which this
    end-device expects the beacon.
    æ­¤å‘½ä»¤ç”±æœåŠ¡å™¨å‘é€åˆ°ç»ˆç«¯è®¾å¤‡ï¼Œä»¥ä¿®æ”¹æ­¤ç»ˆç«¯è®¾å¤‡æœŸæœ›ä¿¡æ ‡çš„é¢‘ç‡ã€‚

    |        Octets         |     3     |
    |-----------------------------------|
    | BeaconFreqReq payload | Frequency |

    The Frequency coding is identical to the NewChannelReq MAC command defined in the Class A.
    é¢‘ç‡ç¼–ç ä¸Aç±»ä¸­å®šä¹‰çš„NewChannelReq MACå‘½ä»¤ç›¸åŒã€‚

    Frequency is a 24bits unsigned integer. The actual beacon channel frequency in Hz is 100 x
    frequ. This allows defining the beacon channel anywhere between 100 MHz to 1.67 GHz by
    100 Hz step. The end-device has to check that the frequency is actually allowed by its radio
    hardware and return an error otherwise.
    é¢‘ç‡æ˜¯24ä½æ— ç¬¦å·æ•´æ•°ã€‚ä»¥Hzä¸ºå•ä½çš„å®é™…ä¿¡æ ‡ä¿¡é“é¢‘ç‡ä¸º100 x frequã€‚
    è¿™å…è®¸ä»¥100Hzçš„æ­¥é•¿å®šä¹‰100MHzåˆ°1.67GHzä¹‹é—´çš„ä»»ä½•ä¿¡æ ‡ä¿¡é“ã€‚
    ç»ˆç«¯è®¾å¤‡å¿…é¡»æ£€æŸ¥å…¶æ— çº¿ç”µç¡¬ä»¶æ˜¯å¦å…è®¸è¯¥é¢‘ç‡ï¼Œå¦åˆ™è¿”å›é”™è¯¯ã€‚

    A valid non-zero Frequency will force the device to listen to the beacon on a fixed frequency
    channel even if the default behavior specifies a frequency hopping beacon (i.e US ISM band).
    æœ‰æ•ˆçš„éé›¶é¢‘ç‡å°†å¼ºåˆ¶è®¾å¤‡åœ¨å›ºå®šé¢‘ç‡ä¿¡é“ä¸Šæ”¶å¬ä¿¡æ ‡ï¼Œå³ä½¿é»˜è®¤è¡Œä¸ºæŒ‡å®šäº†è·³é¢‘ä¿¡æ ‡ï¼ˆå³ç¾å›½ISMé¢‘æ®µï¼‰ã€‚

    A value of 0 instructs the end-device to use the default beacon frequency plan as defined in
    the â€œBeacon physical layerâ€ section. Where applicable the device resumes frequency hopping
    beacon search.
    å€¼ä¸º0æŒ‡ç¤ºç»ˆç«¯è®¾å¤‡ä½¿ç”¨â€œä¿¡æ ‡ç‰©ç†å±‚â€éƒ¨åˆ†ä¸­å®šä¹‰çš„é»˜è®¤ä¿¡æ ‡é¢‘ç‡è®¡åˆ’ã€‚
    åœ¨é€‚ç”¨çš„æƒ…å†µä¸‹ï¼Œè®¾å¤‡æ¢å¤è·³é¢‘ä¿¡æ ‡æœç´¢ã€‚

    Upon reception of this command the end-device answers with a BeaconFreqAns message.
    The MAC payload of this message contains the following information:
    åœ¨æ¥æ”¶åˆ°è¯¥å‘½ä»¤åï¼Œç»ˆç«¯è®¾å¤‡ç”¨BeaconFreqAnsæ¶ˆæ¯åº”ç­”ã€‚æ­¤æ¶ˆæ¯çš„MACè´Ÿè½½åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š

    |      Size(bytes)      |    1    |
    |---------------------------------|
    | BeaconFreqAns Payload | Status  |

![avatar](./chapter14-BeaconFreqAns.png)

## 14.3 PingSlotChannelReq

    This command is sent by the server to the end-device to modify the frequency and/or the data
    rate on which the end-device expects the downlink pings.
    è¯¥å‘½ä»¤ç”±æœåŠ¡å™¨å‘é€åˆ°ç»ˆç«¯è®¾å¤‡ï¼Œä»¥ä¿®æ”¹ç»ˆç«¯è®¾å¤‡æœŸæœ›ä¸‹è¡Œé“¾è·¯pingçš„é¢‘ç‡å’Œ/æˆ–æ•°æ®é€Ÿç‡ã€‚

    This command can only be sent in a class A receive window (following an uplink). The
    command SHALL NOT be sent in a class B ping-slot. If the device receives it inside a class B
    ping-slot, the MAC command SHALL NOT be processed. Once the NS has sent the first
    PingSlotChannelReq command, it SHOULD resend it until it receives a PingSlotChannelAns
    from the device. It MUST NOT attempt to use a class B ping slot until it receives the
    PingSlotChannelAns.
    æ­¤å‘½ä»¤åªèƒ½åœ¨Aç±»æ¥æ”¶çª—å£ä¸­å‘é€ï¼ˆåœ¨ä¸Šè¡Œé“¾è·¯ä¹‹åï¼‰ã€‚
    å‘½ä»¤ä¸èƒ½åœ¨Bç±»pingæ—¶éš™ä¸­å‘é€ã€‚å¦‚æœè®¾å¤‡åœ¨Bç±»pingæ’æ§½ä¸­æ¥æ”¶åˆ°å®ƒï¼Œåˆ™ä¸åº”å¤„ç†MACå‘½ä»¤ã€‚
    ä¸€æ—¦NSå‘é€äº†ç¬¬ä¸€ä¸ªPingSlotChannelReqå‘½ä»¤ï¼Œå®ƒåº”è¯¥é‡æ–°å‘é€å®ƒï¼Œ
    ç›´åˆ°å®ƒä»è®¾å¤‡æ¥æ”¶åˆ°PingSlotChannelAnsã€‚
    ç›´åˆ°åœ¨æ¥æ”¶åˆ°pingslotchannelAnsï¼Œå®ƒä¸èƒ½å°è¯•ä½¿ç”¨classB pingæ’æ§½ã€‚

    |          Octets            |     3     | 1  |
    |---------------------------------------------|
    | PingSlotChannelReq Payload | Frequency | DR |

    The Frequency coding is identical to the NewChannelReq MAC command defined in the
    Class A.
    é¢‘ç‡ç¼–ç ä¸Aç±»ä¸­å®šä¹‰çš„NewChannelReq MACå‘½ä»¤ç›¸åŒã€‚

    Frequency is a 24bits unsigned integer. The actual ping channel frequency in Hz is 100 x
    frequ. This allows defining the ping channel anywhere between 100MHz to 1.67GHz by 100Hz
    step. The end-device has to check that the frequency is actually allowed by its radio hardware
    and return an error otherwise.
    é¢‘ç‡æ˜¯24ä½æ— ç¬¦å·æ•´æ•°ã€‚å®é™…pingé€šé“é¢‘ç‡ï¼ˆHzï¼‰ä¸º100 x frequã€‚
    è¿™å…è®¸é€šè¿‡100Hzæ­¥è¿›å®šä¹‰100MHzåˆ°1.67GHzä¹‹é—´çš„pingé€šé“ã€‚
    ç»ˆç«¯è®¾å¤‡å¿…é¡»æ£€æŸ¥å…¶æ— çº¿ç”µç¡¬ä»¶æ˜¯å¦å…è®¸è¯¥é¢‘ç‡ï¼Œå¦åˆ™è¿”å›é”™è¯¯ã€‚

    A value of 0 instructs the end-device to use the default frequency plan. Where applicable the
    device resumes frequency hopping beacon search.
    å€¼0æŒ‡ç¤ºç»ˆç«¯è®¾å¤‡ä½¿ç”¨é»˜è®¤é¢‘ç‡è®¡åˆ’ã€‚åœ¨é€‚ç”¨çš„æƒ…å†µä¸‹ï¼Œè®¾å¤‡æ¢å¤è·³é¢‘ä¿¡æ ‡æœç´¢ã€‚

    The DR byte contains the following fields:
    DRå­—èŠ‚åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

    | Bits | [7:4] |   [3:0]   |
    |--------------------------|
    |  DR  |  RFU  | Data Rate |

    The â€œdata rateâ€ subfield is the index of the Data Rate used for the ping-slot downlinks. The
    relationship between the index and the physical data rate is defined in [PHY] for each region.
    â€œæ•°æ®é€Ÿç‡â€å­å­—æ®µæ˜¯ç”¨äºpingæ—¶éš™ä¸‹è¡Œé“¾è·¯çš„æ•°æ®é€Ÿç‡çš„ç´¢å¼•ã€‚
    ç´¢å¼•å’Œç‰©ç†æ•°æ®é€Ÿç‡ä¹‹é—´çš„å…³ç³»åœ¨æ¯ä¸ªåŒºåŸŸçš„[PHY]ä¸­å®šä¹‰ã€‚

    Upon reception of this command the end-device answers with a PingSlotFreqAns message.
    The MAC payload of this message contains the following information:
    åœ¨æ¥æ”¶åˆ°è¿™ä¸ªå‘½ä»¤åï¼Œç»ˆç«¯è®¾å¤‡ç”¨PingSlotFreqAnsæ¶ˆæ¯è¿›è¡Œåº”ç­”ã€‚æ­¤æ¶ˆæ¯çš„MACè´Ÿè½½åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š

![avatar](./chapter14-PingSlotChannelAns1.png)
![avatar](./chapter14-PingSlotChannelAns2.png)

    If either of those 2 bits equals 0, the command did not succeed and the ping-slot parameters
    have not been modified.
    å¦‚æœè¿™2ä½ä¸­çš„ä»»ä½•ä¸€ä½ç­‰äº0ï¼Œåˆ™è¯¥å‘½ä»¤æœªæˆåŠŸï¼Œå¹¶ä¸”pingæ’æ§½å‚æ•°æœªè¢«ä¿®æ”¹ã€‚

## 14.4 BeaconTimingReq & BeaconTimingAns

    These MAC commands are deprecated in the LoRaWAN1.0.3 version. The device may use
    DeviceTimeReq&Ans commands as a substitute.
    è¿™äº›MACå‘½ä»¤åœ¨LoRaWAN1.0.3ç‰ˆæœ¬ä¸­å·²è¢«å¼ƒç”¨ã€‚è®¾å¤‡å¯ä»¥ä½¿ç”¨DeviceTimeReq&Anså‘½ä»¤ä½œä¸ºæ›¿ä»£ã€‚
