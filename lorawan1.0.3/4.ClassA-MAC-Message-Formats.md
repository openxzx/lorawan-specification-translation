# MAC Message Formats

    All LoRa uplink and downlink messages carry
    a PHY payload (Payload) starting with a single-octet MAC header (MHDR),
    followed by a MAC payload (MACPayload), and ending with a 4-octet message integrity code (MIC).
    所有LoRa上行链路和下行链路消息都携带一个PHY有效载荷（payload），从单八位字节MAC报头（MHDR）开始，
    然后是MAC有效载荷（MAC payload），最后是4个八位字节的消息完整性代码（MIC）。

![avatar](./phypayload-format.png)

## 4.1 MAC Layer (PHYPayload)

    | Size(bytes) |   1   |   1 .. N   |   4   |
    |------------------------------------------|
    | PHYPayload  |  MHDR | MACPayload |  MIC  |

    The maximum length (M) of the MACPayload field is region specific and is specified in Chapter 6.
    MACPayload字段的最大长度（M）因地区而异，在第6章中有规定。

## 4.2 MAC Header (MHDR field)

    |    Bit#   |  7..5  | 4..2 |  1..0  |
    |------------------------------------|
    | MHDR Bit  |  Mtype | RFU  |  Major |

    The MAC header specifies the message type (MType) and according to which
    major version (Major) of the frame format of the LoRaWAN layer specification the frame has been encoded.
    MAC报头指定消息类型（MType）以及根据LoRaWAN层规范的帧格式的主要版本（major）对帧进行编码。

### 4.2.1 Message type (MType bit field)

    The LoRaWAN distinguishes between six different MAC message types: join request, join accept,
    unconfirmed data up/down, and confirmed data up/down.
    LoRaWAN区分了六种不同的MAC消息类型：加入请求/接受、未确认数据上/下、确认数据上/下。

    |  Mtype  |       Description        |
    |------------------------------------|
    |   000   |       Join Request       |
    |   001   |       Join Accept        |
    |   010   |   Unconfirmed Data Up    |
    |   011   |   Unconfirmed Data Down  |
    |   100   |   Confirmed Data Up      |
    |   101   |   Confirmed Data Down    |
    |   110   |           RFU            |
    |   111   |   Proprietary(专有的)    |

#### 4.2.1.1 Join-request and join-accept messages

    The join-request and join-accept messages are used by the over-the-air activation procedure
    described in Chapter 6.2.
    加入请求和加入接受消息用于第6.2章中所述的“空中传送”激活过程。

#### 4.2.1.2 Data messages

    Data messages are used to transfer both MAC commands and application data, which can be
    combined together in a single message. A confirmed-data message has to be
    acknowledged by the receiver, whereas an unconfirmed-data message does not require an acknowledgment.
    Proprietary messages can be used to implement non-standard message
    formats that are not interoperable with standard messages but must only be used among
    devices that have a common understanding of the proprietary extensions.
    数据消息用于传输MAC命令和应用程序数据，它们可以组合在一条消息中。
    已确认的数据消息必须由接收方确认，而未确认的数据消息不需要确认。
    专有消息可用于实现与标准消息不可互操作的非标准消息格式，但只能在对专有扩展有共同理解的设备之间使用。

    Message integrity is ensured in different ways for different message types and is described
    per message type below.
    对于不同的消息类型，以不同的方式确保消息的完整性，下面对每个消息类型进行了描述。

### 4.2.2 Major version of data message (Major bit field)

    |  Major bits  |     Description     |
    |------------------------------------|
    |      00      |     LoRaWAN R1      |
    |    01..11    |        RFU          |

    Note: The Major version specifies the format of the messages
    exchanged in the join procedure (see Chapter 6.2) and the first four
    bytes of the MAC Payload as described in Chapter 4. For each major
    version, end-devices may implement different minor versions of the
    frame format. The minor version used by an end-device must be made
    known to the network server beforehand using out of band messages
    (e.g., as part of the device personalization information).
    注：主版本指定了在连接过程中交换的消息的格式（见第6.2章）和第4章中描述的MAC有效载荷的前四个字节。
    对于每个主要版本，终端设备可以实现帧格式的不同次要版本。
    终端设备使用的次要版本必须事先使用带外消息（例如，作为设备个性化信息的一部分）通知网络服务器。

## 4.3 MAC Payload of Data Messages (MACPayload)

    The MAC payload of the data messages, a so-called “data frame”, contains a frame header (FHDR)
    followed by an optional port field (FPort) and an optional frame payload field (FRMPayload).
    数据消息的MAC有效载荷，即所谓的“数据帧”，包含帧头（FHDR），
    后跟可选端口字段（FPort）和可选帧有效载荷字段（FRMPayload）。

### 4.3.1 Frame header (FHDR)

    The FHDR contains the short device address of the end-device (DevAddr), a frame control
    octet (FCtrl), a 2-octets frame counter (FCnt), and up to 15 octets of frame options (FOpts)
    used to transport MAC commands.
    FHDR包含终端设备的短设备地址（DevAddr）、帧控制1个八位字节（FCtrl）、
    2个八位字节帧计数器（FCnt）和用于传输MAC命令的多达15个八位字节的帧选项（FOpts）。
    |  Size bytes  |    1    |   1   |   2   |  1..15  |
    |--------------------------------------------------|
    |     FHDR     | DevAddr | FCtrl | Fcnt  |  FOpts  |

    For downlink frames the FCtrl content of the frame header is:
    对于下行帧，帧头的FCtrl内容为：
    |    Bit#    |   7   |   6   |   5   |    4     |   3..0   |
    |----------------------------------------------------------|
    | FCtrl bits |  ADR  |  RFU  |  ACK  | FPending | FOptsLen |

    For uplink frames the FCtrl content of the frame header is:
    对于上行链路帧，帧头的FCtrl内容为：
    |    Bit#    |   7   |     6     |   5   |   4    |   3..0   |
    |------------------------------------------------------------|
    | FCtrl bits |  ADR  | ADRACKReq |  ACK  | ClassB | FOptsLen |
